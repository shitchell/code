#!/bin/bash
#
# compares two files created by `opg-as9-get-cherrypicks` and finds any lines
# where the timestamp in the second file is earlier than the timestamp in the
# first file

file1="${1}"
file2="${2}"

usage() {
  echo "usage: $(basename "$0") cherrypick-file1 cherrypick-file2"
}

generate_header() {
	filename="${1}"

	if echo "${filename}" | grep -q "checkins"; then
		branch=${filename%%-checkins-*}
		echo "Last check-in to ${branch}"
		return 0
	elif echo "${filename}" | grep -q "cherry-picks"; then
		branch=${filename%%-cherry-picks-*}
		echo "Last cherry-pick to ${branch}"
		return 0
	fi
	
	# filename didn't match any known format
	return 1
}

[ -z "${file2}" ] && usage >&2 && exit 1

file1_header="$(generate_header "${file1}")"
file2_header="$(generate_header "${file2}")"

echo "Customization,${file1_header},${file2_header}"
awk -v FPAT='([^, ]+)|("[^"]+")' \
            'NR==FNR {a_epoch[NR]=$3;a_ts[NR]=$2; next} a_epoch[FNR] > $3 {print $1","a_ts[FNR]","$2}' \
            "${file1}" "${file2}"
