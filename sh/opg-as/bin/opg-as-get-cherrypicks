#!/bin/bash
#
# This script will determine which customizations have been cherry-picked since
# the given date and return each cherry-picked commit in the format:
#   <commit-hash> <commit-timestamp> <files-changed> <cusotmization-id>

## Import common functions #####################################################
################################################################################
include-source "echo.sh"

## Usage functions #############################################################
################################################################################

function usage() {
    echo "usage: $(basename $0) <since-date>"
    echo " e.g.: $(basename $0) '2022-07-01 13:37:00'"
}

function check-params() {
    if [ -z "${SINCE}" ]; then
        usage >&2
        exit 1
    fi
}

function parse-args() {
    # Create an array to hold positional arguments
    declare -a positional_args
    while [ ${#} -gt 0 ]; do
        case "${1}" in
            -h|--help)
                usage
                exit 0
                ;;
            -s|--since)
                SINCE="${2}"
                shift 2
                ;;
            *)
                positional_args+=("${1}")
                shift
                ;;
        esac
    done
    # Set positional args in the global array $@
    set -- "${positional_args[@]}"
}

## Functional functions #######################################################
################################################################################

function get-cherrypicked-customizations() {
    since="${1}"
    git log --after="${since}" --no-merges --grep="Cherry-picking for" --shortstat --pretty="%at%x09%h%x09%s%x09" \
        | sed ':a;N;$!ba;s/\n\n /\t/g' \
        | sed 's/Cherry-picking for //g' \
        | sed -E 's/\(.*?\)//' \
        | awk -F ' ' '{if ($4 > 10) {print $2 " " $1 " " $4 " " $3}}'
}

## main ########################################################################
################################################################################

function main() {
    parse-args "${@}"
    check-params
    # Update the repo
    git fetch --all
    get-cherrypicked-customizations "${SINCE}"
}

# Run the main function if this script is being run directly
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "${@}"
