#!/usr/bin/env bash
#
# Capture terminal output from tmux and send it to an AI assistant for analysis.
# Useful for debugging failed commands or understanding unexpected behavior.


## exit codes ##################################################################
################################################################################

declare -ri E_SUCCESS=0
declare -ri E_ERROR=1
declare -ri E_NO_TMUX=2


## configuration ###############################################################
################################################################################

# The AI command to use for analysis. This is an array to handle commands with
# arguments or spaces properly. Override in config file or environment.
# Examples:
#   AI_CMD=("claude")
#   AI_CMD=("gemini-cli" "chat")
#   AI_CMD=("ollama" "run" "llama3")
declare -a AI_CMD
AI_CMD=("${AI_CMD[@]:-claude}")

# Default number of lines to capture from tmux scrollback
declare -i DEFAULT_LINES=500


## usage functions #############################################################
################################################################################

function help-usage() {
    echo "usage: $(basename "${0}") [-h] [-n <lines>] [-p <pane>] [<prompt>] [-- <ai args>...]"
}

function help-epilogue() {
    echo "capture tmux output and send it to an AI assistant for analysis"
}

function help-full() {
    help-usage
    help-epilogue
    echo
    cat << EOF
Captures the last N lines from your tmux pane's scrollback buffer and sends
them to an AI assistant with context about the capture. Useful for debugging
failed commands or getting help understanding terminal output.

Options:
    -h                    display usage
    --help                display this help message
    -n/--lines <count>    number of lines to capture (default: ${DEFAULT_LINES})
    -p/--pane <target>    tmux pane to capture (default: current pane)
    -d/--dry-run          print captured output instead of sending to AI
    --config-file <file>  use the specified configuration file
    --                    pass remaining arguments to the AI command

Arguments:
    <prompt>              additional context or question to include with the
                          captured output (e.g., "why is this failing?")

Configuration:
    The AI command can be configured via:
    1. Config file (~/.ainvestigate-tmux.conf by default)
    2. AI_CMD environment variable (as a bash array)

    Example config file:
        AI_CMD=("gemini-cli" "chat")
        DEFAULT_LINES=1000

Examples:
    $(basename "${0}")                    # Capture last 500 lines, send to AI
    $(basename "${0}") "why did this fail?"  # Include a question
    $(basename "${0}") -n 100             # Capture last 100 lines
    $(basename "${0}") -p %1              # Capture from pane %1
    $(basename "${0}") -- --dangerously-skip-permissions  # Pass args to AI
EOF
}

function parse-args() {
    # Parse the arguments first for a config file to load default values from
    CONFIG_FILE="${HOME}/.$(basename "${0}").conf"
    for ((i=0; i<${#}; i++)); do
        case "${!i}" in
            -c | --config-file)
                ((i++))
                CONFIG_FILE="${!i}"
                ;;
        esac
    done
    [[ -f "${CONFIG_FILE}" ]] && source "${CONFIG_FILE}"

    # Default values
    declare -gi CAPTURE_LINES="${DEFAULT_LINES}"
    TMUX_PANE=""  # Empty means current pane
    DO_DRY_RUN=false
    USER_PROMPT=""
    AI_ARGS=()

    # Loop over the arguments
    while [[ ${#} -gt 0 ]]; do
        case ${1} in
            -h)
                help-usage
                help-epilogue
                exit ${E_SUCCESS}
                ;;
            --help)
                help-full
                exit ${E_SUCCESS}
                ;;
            --config-file)
                shift 1
                ;;
            -n | --lines)
                CAPTURE_LINES="${2}"
                shift 1
                ;;
            -p | --pane)
                TMUX_PANE="${2}"
                shift 1
                ;;
            -d | --dry-run)
                DO_DRY_RUN=true
                ;;
            --)
                shift 1
                break
                ;;
            -*)
                echo "error: unknown option: ${1}" >&2
                return ${E_ERROR}
                ;;
            *)
                # Positional argument is the user's additional prompt
                USER_PROMPT="${1}"
                ;;
        esac
        shift 1
    done

    # Collect remaining arguments for the AI command
    while [[ ${#} -gt 0 ]]; do
        AI_ARGS+=("${1}")
        shift 1
    done

    return ${E_SUCCESS}
}


## helpful functions ###########################################################
################################################################################

function check-tmux() {
    : 'Verify we are running inside a tmux session

        @return 0 if inside tmux, E_NO_TMUX otherwise
    '
    if [[ -z "${TMUX}" ]]; then
        echo "error: not running inside a tmux session" >&2
        echo "hint: start tmux first, or use ainvestigate-script for non-tmux terminals" >&2
        return ${E_NO_TMUX}
    fi
    return ${E_SUCCESS}
}

function capture-pane-output() {
    : 'Capture the scrollback buffer from a tmux pane

        @arg $1 - Number of lines to capture
        @arg $2 - (optional) Pane target, defaults to current pane
        @stdout The captured output
    '
    local -i __lines="${1}"
    local -- __pane="${2:-}"
    local -a __tmux_args=()

    # Build tmux capture-pane arguments
    __tmux_args+=("-p")                    # Print to stdout
    __tmux_args+=("-S" "-${__lines}")      # Start N lines back

    if [[ -n "${__pane}" ]]; then
        __tmux_args+=("-t" "${__pane}")
    fi

    tmux capture-pane "${__tmux_args[@]}"
}

function build-prompt() {
    : 'Build the prompt to send to the AI with captured output

        @arg $1 - The captured terminal output
        @stdout The formatted prompt
    '
    local -- __output="${1}"
    local -- __timestamp
    local -- __pwd
    local -- __shell

    __timestamp="$(date '+%Y-%m-%d %H:%M:%S %Z')"
    __pwd="${PWD}"
    __shell="${SHELL##*/}"

    cat << EOF
<terminal-capture>
<metadata>
<captured-at>${__timestamp}</captured-at>
<working-directory>${__pwd}</working-directory>
<shell>${__shell}</shell>
<lines-captured>${CAPTURE_LINES}</lines-captured>
<note>This is LIVE output from the user's CURRENT terminal session, captured just now via tmux scrollback. The user is actively working on this and needs help understanding or debugging what they see.</note>
</metadata>
<output>
${__output}
</output>
</terminal-capture>

Please analyze the terminal output above. Look for:
1. Any errors or warnings and what might have caused them
2. The last few commands that were run and their results
3. Suggestions for how to fix or proceed

If you need more context (e.g., file contents, more history), just ask.
EOF
}


## main ########################################################################
################################################################################

function main() {
    parse-args "${@}" || return ${?}
    check-tmux || return ${?}

    # Capture the pane output
    local -- captured_output
    captured_output="$(capture-pane-output "${CAPTURE_LINES}" "${TMUX_PANE}")"

    if [[ -z "${captured_output}" ]]; then
        echo "error: no output captured from tmux pane" >&2
        return ${E_ERROR}
    fi

    # Build the full prompt
    local -- prompt
    prompt="$(build-prompt "${captured_output}")"

    # Append user's additional context if provided
    if [[ -n "${USER_PROMPT}" ]]; then
        prompt+=$'\n---\n\n'"${USER_PROMPT}"
    fi

    # Either print (dry-run) or send to AI
    if ${DO_DRY_RUN}; then
        echo "${prompt}"
    else
        # Use the AI command array plus any additional args
        "${AI_CMD[@]}" "${AI_ARGS[@]}" "${prompt}"
    fi
}


## run #########################################################################
################################################################################

[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "${@}"
