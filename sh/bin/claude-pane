#!/usr/bin/env bash
set -euo pipefail

# claude-pane: Open a tmux pane for Claude Code sessions
# Tracks opened panes to prevent duplicates in the same position

MARKER_DIR="/tmp/claude-pane.${USER:-$(id -un)}"
PROGRAM_NAME="$(basename "$0")"

usage() {
    cat <<EOF
Usage: $PROGRAM_NAME --position <side|below> [--exec] --command <cmd>
       $PROGRAM_NAME --position <side|below> --update --command <cmd>
       $PROGRAM_NAME --position <side|below> --kill
       $PROGRAM_NAME --list
       $PROGRAM_NAME --position <side|below> [--exec] [--] <command> [args...]

Open a tmux pane at the specified position.

Options:
  --position <side|below>  Where to open the pane (side=right, below=bottom)
  --command <cmd>          Command to run (preferred, avoids quoting issues)
  --exec                   Run command with 'exec' prefix (pane closes when done)
  --update                 Replace command in existing pane (avoids resize flicker)
  --kill                   Kill the pane at the specified position
  --list                   List all active claude-panes
  --help                   Show this help message

Examples:
  $PROGRAM_NAME --position side --command 'npm run dev'
  $PROGRAM_NAME --position below --exec --command 'echo hello && sleep 5'
  $PROGRAM_NAME --position side --update --command 'npm run build'
  $PROGRAM_NAME --position side --kill
  $PROGRAM_NAME --list
EOF
    exit "${1:-0}"
}

die() {
    echo "error: $*" >&2
    exit 1
}

# Find the tmux pane ID for the current process by walking up the process tree
# to find a tty, then matching it against tmux panes
find_current_pane() {
    # Fast path: $TMUX_PANE is set
    if [[ -n "${TMUX_PANE:-}" ]]; then
        echo "$TMUX_PANE"
        return 0
    fi

    # Walk up process tree to find a tty
    local pid=$$ tty_name=""
    while [[ $pid -gt 1 ]]; do
        tty_name=$(ps -o tty= -p "$pid" 2>/dev/null | tr -d ' ')
        if [[ -n "$tty_name" && "$tty_name" != "?" ]]; then
            break
        fi
        pid=$(ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ')
    done

    [[ -n "$tty_name" && "$tty_name" != "?" ]] || return 1

    # Match tty to tmux pane
    local pane_id
    pane_id=$(tmux list-panes -a -F '#{pane_id} #{pane_tty}' 2>/dev/null \
        | grep "/dev/${tty_name}$" \
        | awk '{print $1}')

    [[ -n "$pane_id" ]] || return 1
    echo "$pane_id"
}

# Global variable for the source pane (set by check_tmux)
SOURCE_PANE=""

# Validate we're in tmux and find our pane
check_tmux() {
    # Quick check: if $TMUX is empty and tmux isn't reachable, bail early
    if [[ -z "${TMUX:-}" ]]; then
        if ! tmux list-sessions &>/dev/null; then
            die "not inside a tmux session"
        fi
    fi

    # Find our actual pane
    SOURCE_PANE=$(find_current_pane) || die "not inside a tmux session"
}

# Get current tmux session ID for namespacing markers
get_session_id() {
    tmux display-message -t "$SOURCE_PANE" -p '#{session_id}'
}

# Clean up stale marker files by validating pane still exists
cleanup_stale_markers() {
    [[ -d "$MARKER_DIR" ]] || return 0

    for marker in "$MARKER_DIR"/*; do
        [[ -f "$marker" ]] || continue

        # Read marker contents
        local pane_id tty_path
        pane_id=$(sed -n '2p' "$marker" 2>/dev/null || true)
        tty_path=$(sed -n '3p' "$marker" 2>/dev/null || true)

        # Check if pane still exists
        if [[ -n "$pane_id" ]]; then
            if ! tmux list-panes -a -F '#{pane_id}' 2>/dev/null | grep -qxF "$pane_id"; then
                rm -f "$marker"
                continue
            fi
        fi

        # Check if tty is still active
        if [[ -n "$tty_path" ]] && [[ ! -e "$tty_path" ]]; then
            rm -f "$marker"
            continue
        fi
    done
}

# Check if a pane already exists at the given position for this session
check_position_available() {
    local position="$1"
    local session_id="$2"
    local marker_file="$MARKER_DIR/${session_id}_${position}"

    if [[ -f "$marker_file" ]]; then
        # Validate marker is still valid
        local pane_id pane_title
        pane_title=$(sed -n '1p' "$marker_file" 2>/dev/null || true)
        pane_id=$(sed -n '2p' "$marker_file" 2>/dev/null || true)

        if tmux list-panes -a -F '#{pane_id}' 2>/dev/null | grep -qxF "$pane_id"; then
            die "pane already open at position '$position' (title: $pane_title, pane: $pane_id)"
        else
            # Stale marker, remove it
            rm -f "$marker_file"
        fi
    fi
}

# Create marker file for the new pane
create_marker() {
    local position="$1"
    local session_id="$2"
    local pane_id="$3"
    local pane_title="$4"
    local tty_path="$5"

    mkdir -p "$MARKER_DIR"
    local marker_file="$MARKER_DIR/${session_id}_${position}"

    cat > "$marker_file" <<EOF
$pane_title
$pane_id
$tty_path
EOF
}

# Get pane info from marker file, returns empty if not found/stale
get_pane_at_position() {
    local position="$1"
    local session_id="$2"
    local marker_file="$MARKER_DIR/${session_id}_${position}"

    [[ -f "$marker_file" ]] || return 1

    local pane_id
    pane_id=$(sed -n '2p' "$marker_file" 2>/dev/null || true)

    # Validate pane still exists
    if [[ -n "$pane_id" ]] && tmux list-panes -a -F '#{pane_id}' 2>/dev/null | grep -qxF "$pane_id"; then
        echo "$pane_id"
        return 0
    fi

    # Stale marker
    rm -f "$marker_file"
    return 1
}

# Kill pane at position
do_kill() {
    local position="$1"
    local session_id="$2"
    local marker_file="$MARKER_DIR/${session_id}_${position}"

    local pane_id
    if ! pane_id=$(get_pane_at_position "$position" "$session_id"); then
        die "no pane at position '$position'"
    fi

    tmux kill-pane -t "$pane_id"
    rm -f "$marker_file"
    echo "killed pane $pane_id at position '$position'"
}

# Update command in existing pane using respawn-pane
do_update() {
    local position="$1"
    local session_id="$2"
    local new_cmd="$3"
    local use_exec="$4"
    local marker_file="$MARKER_DIR/${session_id}_${position}"

    local pane_id
    if ! pane_id=$(get_pane_at_position "$position" "$session_id"); then
        die "no pane at position '$position' to update"
    fi

    local full_cmd="$new_cmd"
    if [[ "$use_exec" == true ]]; then
        full_cmd="exec $new_cmd"
    fi

    # Respawn the pane with new command (-k kills existing process)
    tmux respawn-pane -t "$pane_id" -k "$full_cmd"

    # Update marker with new title
    local cmd_name="${new_cmd%% *}"
    local pane_title="claude-pane:${position}:${cmd_name}"
    local tty_path
    tty_path=$(tmux display-message -t "$pane_id" -p '#{pane_tty}')

    tmux select-pane -t "$pane_id" -T "$pane_title"
    create_marker "$position" "$session_id" "$pane_id" "$pane_title" "$tty_path"

    echo "updated pane $pane_id at position '$position'"
}

# List all active claude-panes
do_list() {
    cleanup_stale_markers

    if [[ ! -d "$MARKER_DIR" ]] || [[ -z "$(ls -A "$MARKER_DIR" 2>/dev/null)" ]]; then
        echo "no active claude-panes"
        return 0
    fi

    echo "active claude-panes:"
    for marker in "$MARKER_DIR"/*; do
        [[ -f "$marker" ]] || continue

        local pane_title pane_id tty_path
        pane_title=$(sed -n '1p' "$marker" 2>/dev/null || true)
        pane_id=$(sed -n '2p' "$marker" 2>/dev/null || true)
        tty_path=$(sed -n '3p' "$marker" 2>/dev/null || true)

        local marker_name
        marker_name=$(basename "$marker")
        local session_pos="${marker_name#*_}"  # extract position from filename

        echo "  $session_pos: $pane_id ($pane_title) on $tty_path"
    done
}

main() {
    local position=""
    local use_exec=false
    local command_str=""
    local cmd=()
    local do_kill_flag=false
    local do_update_flag=false
    local do_list_flag=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --position)
                [[ $# -ge 2 ]] || die "--position requires an argument"
                position="$2"
                shift 2
                ;;
            --command)
                [[ $# -ge 2 ]] || die "--command requires an argument"
                command_str="$2"
                shift 2
                ;;
            --exec)
                use_exec=true
                shift
                ;;
            --kill)
                do_kill_flag=true
                shift
                ;;
            --update)
                do_update_flag=true
                shift
                ;;
            --list)
                do_list_flag=true
                shift
                ;;
            --help|-h)
                usage 0
                ;;
            --)
                shift
                cmd=("$@")
                break
                ;;
            -*)
                die "unknown option: $1"
                ;;
            *)
                cmd=("$@")
                break
                ;;
        esac
    done

    # Handle --list (doesn't need position or tmux check beyond cleanup)
    if [[ "$do_list_flag" == true ]]; then
        do_list
        return 0
    fi

    # All other operations need position
    [[ -n "$position" ]] || die "--position is required"
    [[ "$position" == "side" || "$position" == "below" ]] || die "--position must be 'side' or 'below'"

    check_tmux
    cleanup_stale_markers

    local session_id
    session_id=$(get_session_id)

    # Handle --kill
    if [[ "$do_kill_flag" == true ]]; then
        do_kill "$position" "$session_id"
        return 0
    fi

    # Handle --update
    if [[ "$do_update_flag" == true ]]; then
        [[ -n "$command_str" ]] || die "--update requires --command"
        do_update "$position" "$session_id" "$command_str" "$use_exec"
        return 0
    fi

    # Default: open new pane
    [[ -n "$command_str" || ${#cmd[@]} -gt 0 ]] || die "--command or command arguments required"

    check_position_available "$position" "$session_id"

    # Determine split direction
    local split_opt
    if [[ "$position" == "side" ]]; then
        split_opt="-h"  # horizontal split = pane to the right
    else
        split_opt="-v"  # vertical split = pane below
    fi

    # Build the command to run in the pane
    local base_cmd
    if [[ -n "$command_str" ]]; then
        base_cmd="$command_str"
    else
        base_cmd="${cmd[*]}"
    fi

    # Extract first word for the pane title
    local cmd_name="${base_cmd%% *}"
    local pane_title="claude-pane:${position}:${cmd_name}"
    local full_cmd

    if [[ "$use_exec" == true ]]; then
        # Use exec so pane closes when command exits
        full_cmd="exec $base_cmd"
    else
        full_cmd="$base_cmd"
    fi

    # Create the pane and capture its ID (split from our source pane)
    local new_pane_id
    new_pane_id=$(tmux split-window -t "$SOURCE_PANE" $split_opt -d -P -F '#{pane_id}' "$full_cmd")

    # Set the pane title
    tmux select-pane -t "$new_pane_id" -T "$pane_title"

    # Get the tty of the new pane
    local tty_path
    tty_path=$(tmux display-message -t "$new_pane_id" -p '#{pane_tty}')

    # Create marker
    create_marker "$position" "$session_id" "$new_pane_id" "$pane_title" "$tty_path"

    echo "opened pane $new_pane_id at position '$position'"
}

main "$@"
